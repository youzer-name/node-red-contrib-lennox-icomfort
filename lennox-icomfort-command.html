<script type="text/javascript">
    RED.nodes.registerType('lennox-icomfort-command', {
        category: 'function',
        color: '#AAAA66',
        defaults: {
            name: { value: '' },
            command: { value: 'refresh', required: true },
            heatingSetpoint: { value: '', validate: function (v) { return v === '' || !isNaN(Number(v)); } },
            coolingSetpoint: { value: '', validate: function (v) { return v === '' || !isNaN(Number(v)); } },
            mode: { value: '' },
            fanmode: { value: '' },
            thermostatmode: { value: '' },
            polling: { value: '', validate: function (v) { return v === '' || !isNaN(Number(v)); } }
        },
        inputs: 1,
        outputs: 1,
        icon: 'font-awesome/fa-thermometer-half',
        label: function () { return this.name || 'lennox-icomfort-command'; },
        oneditprepare: function () {
            function showFields() {
                var cmd = $("#node-input-command").val();
                $(".row-heatingSetpoint, .row-coolingSetpoint, .row-mode, .row-fanmode, .row-thermostatmode").hide();
                if (cmd === 'setSetpoints') {
                    $(".row-heatingSetpoint, .row-coolingSetpoint").show();
                } else if (cmd === 'setThermostatMode') {
                    $(".row-thermostatmode").show();
                } else if (cmd === 'setFanMode') {
                    $(".row-fanmode").show();
                }
                // For heatLevelUp, heatLevelDown, coolLevelUp, coolLevelDown, do not show setpoint fields
                // All other commands: no extra fields
            }
            $("#node-input-command").change(showFields);
            showFields();
        },
        oneditsave: function () {
            var cmd = $("#node-input-command").val();
            // Only enforce deadband for setSetpoints command
            if (cmd === 'setSetpoints') {
                var heat = parseFloat($("#node-input-heatingSetpoint").val());
                var cool = parseFloat($("#node-input-coolingSetpoint").val());
                if (!isNaN(heat) && !isNaN(cool) && (cool - heat < 3)) {
                    RED.notify("Cooling setpoint must be at least 3°F higher than heating setpoint (deadband).", "error");
                    throw new Error("Deadband not met");
                }
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="lennox-icomfort-command">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
</div>
<div class="form-row">
    <label for="node-input-command"><i class="fa fa-cogs"></i> Command</label>
    <select id="node-input-command">
        <option value="refresh">refresh</option>
    <option value="systemInfo">systemInfo</option>
        <option value="setSetpoints">setSetpoints</option>
        <option value="setThermostatMode">setThermostatMode</option>
        <option value="setFanMode">setFanMode</option>
        <option value="away">away</option>
        <option value="home">home</option>
        <option value="heatLevelUp">heatLevelUp</option>
        <option value="heatLevelDown">heatLevelDown</option>
        <option value="coolLevelUp">coolLevelUp</option>
        <option value="coolLevelDown">coolLevelDown</option>
    </select>
</div>
<div class="form-row row-heatingSetpoint" style="display:none">
    <label for="node-input-heatingSetpoint"><i class="fa fa-fire"></i> Heating Setpoint</label>
    <input type="number" id="node-input-heatingSetpoint" step="0.01">
</div>
<div class="form-row row-coolingSetpoint" style="display:none">
    <label for="node-input-coolingSetpoint"><i class="fa fa-snowflake-o"></i> Cooling Setpoint</label>
    <input type="number" id="node-input-coolingSetpoint" step="0.01">
</div>
<div class="form-row row-thermostatmode" style="display:none">
    <label for="node-input-thermostatmode"><i class="fa fa-exchange"></i> Thermostat Mode</label>
    <select id="node-input-thermostatmode">
        <option value="off">off</option>
        <option value="heat">heat</option>
        <option value="cool">cool</option>
        <option value="auto">auto</option>
        <option value="emergency heat">emergency heat</option>
    </select>
</div>
<div class="form-row row-fanmode" style="display:none">
    <label for="node-input-fanmode"><i class="fa fa-refresh"></i> Fan Mode</label>
    <select id="node-input-fanmode">
        <option value="auto">auto</option>
        <option value="on">on</option>
        <option value="circulate">circulate</option>
    </select>
</div>
</script>

<script type="text/x-red" data-help-name="lennox-icomfort-command">
<p>Send a command to the Lennox iComfort Thermostat via the thermostat node. Select a command and fill in any required parameters. This node does not require a config node and simply outputs the command/params for the thermostat node to process.</p>
<p><b>Deadband enforcement:</b> For <code>setSetpoints</code>, the cooling setpoint must be at least 3°F higher than the heating setpoint. The editor will prevent saving if this requirement is not met.</p>
</script>